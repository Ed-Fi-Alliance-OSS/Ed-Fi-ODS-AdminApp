name: 'E2E Reports'
on:
  workflow_run:
    workflows: ['E2E Tests']
    types:
      - completed

env:
  JIRA_ACCESS_TOKEN: ${{ secrets.JIRA_ACCESS_TOKEN }}
  ADMIN_APP_VERSION: '2.3.1'
  PROJECT_ID: '11900'
  CYCLE_NAME: 'Automation Cycle'
  TASK_NAME: 'Playwright Automation Task'
  FOLDER_NAME: 'Playwright Automation Run'

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
    - name: Generate report
      uses: dorny/test-reporter@0d00bb14cb0cc2c9b8985df6e81dd333188224e1 #v1.5.0
      with:
        artifact: test-results
        name: Playwright Tests
        path: '*.xml'
        reporter: java-junit
    - name: Send report to Zephyr
      if: contains(github.ref, 'main')
      run: |
        $parameters = @{
            cycleName = '${{ env.CYCLE_NAME }}'
            taskName = '${{ env.TASK_NAME }}'
            folderName = '${{ env.FOLDER_NAME }}'
        }
        .\send-test-results.ps1 -PersonalAccessToken ${{ env.JIRA_ACCESS_TOKEN }} -ProjectId ${{ env.PROJECT_ID }} -AdminAppVersion '${{ env.ADMIN_APP_VERSION }}' -ResultsFilePath '${{ env.RESULTS_FILE }}' -ConfigParams $parameters
      shell: pwsh
